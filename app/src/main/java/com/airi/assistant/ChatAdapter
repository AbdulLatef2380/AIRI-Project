package com.airi.assistant

import android.view.LayoutInflater
import android.view.View
import android.view.ViewGroup
import android.widget.TextView
import androidx.recyclerview.widget.RecyclerView
import com.airi.assistant.accessibility.BehaviorEngine // âœ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ù…Ø­Ø±Ùƒ Ø§Ù„Ø°ÙƒÙŠ

class ChatAdapter(
    private val onSuggestionClick: (String) -> Unit = {} // ÙƒÙˆÙ„Ø¨Ø§Ùƒ Ù„ØªÙ†ÙÙŠØ° Ø§Ù„Ø£Ù…Ø±
) : RecyclerView.Adapter<ChatAdapter.ChatViewHolder>() {

    private val messages = mutableListOf<ChatModel>()

    override fun getItemViewType(position: Int): Int {
        return if (messages[position].isUser) 1 else 2
    }

    override fun onCreateViewHolder(parent: ViewGroup, viewType: Int): ChatViewHolder {
        val layout = if (viewType == 1) R.layout.item_chat_user else R.layout.item_chat_ai
        val view = LayoutInflater.from(parent.context).inflate(layout, parent, false)
        return ChatViewHolder(view)
    }

    override fun onBindViewHolder(holder: ChatViewHolder, position: Int) {
        val message = messages[position]
        holder.textView.text = message.text

        // ğŸ’¡ Ù…Ù†Ø·Ù‚ Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù„Ø§Ù‚ØªØ±Ø§Ø­Ø§Øª
        if (!message.isUser && message.text.contains("ğŸ’¡")) {
            holder.itemView.setOnClickListener {
                // 1. ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù†Øµ Ù…Ù† Ø§Ù„Ø¥ÙŠÙ…ÙˆØ¬ÙŠ ÙˆØ§Ù„Ø¨Ø§Ø¯Ø¦Ø© Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù†ÙŠØ© Ø§Ù„ØµØ§ÙÙŠØ©
                val cleanText = message.text
                    .replace("ğŸ’¡ Ø§Ù‚ØªØ±Ø§Ø­ Ø°ÙƒÙŠ: ", "")
                    .replace("ğŸ’¡ Ø§Ù‚ØªØ±Ø§Ø­: ", "")
                    .trim()

                // 2. ğŸ”¥ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Ù‡Ù†Ø§ AIRI ÙŠØªØ¹Ù„Ù…!)
                BehaviorEngine.recordUsage(cleanText)

                // 3. ØªÙ†ÙÙŠØ° Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ (Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù†Øµ Ù„Ù€ Llama Ø£Ùˆ n8n)
                onSuggestionClick(cleanText)
            }
            
            // ØªÙ…ÙŠÙŠØ² Ø¨ØµØ±ÙŠ Ø¨Ø³ÙŠØ· (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
            holder.itemView.alpha = 0.9f 
        } else {
            // Ø±Ø³Ø§Ù„Ø© Ø¹Ø§Ø¯ÙŠØ©ØŒ Ù„Ø§ ØªÙØ¹Ù„ Ø´ÙŠØ¦Ø§Ù‹ Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ·
            holder.itemView.setOnClickListener(null)
            holder.itemView.alpha = 1.0f
        }
    }

    override fun getItemCount(): Int = messages.size

    fun addMessage(message: ChatModel) {
        messages.add(message)
        notifyItemInserted(messages.size - 1)
    }

    class ChatViewHolder(itemView: View) : RecyclerView.ViewHolder(itemView) {
        val textView: TextView = itemView.findViewById(R.id.message_text)
    }
}
